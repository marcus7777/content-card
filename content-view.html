<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../quill-js/quill-js.html">
<link rel="import" href="../polymer/polymer.html">
<!--
  `<content-card></content-card>`
  @demo demo.html
-->
<dom-module id="content-view">
  <template>
    <style is="custom-style">
      :host {
        display:block;
        color:#505050;
        font-family: Roboto, Arial, Helvetica, sans-serif;
        font-weight: 300;
      };
      .container {
        min-height: 225px;
        text-align: center;
      };
      .box {
        @apply(--layout-horizontal);
      };
      .leftMargin {
        @apply(--layout-flex-2);
      };
      .leftMarginmob {
        @apply(--layout-flex-0);
      };
      .rightMargin {
        @apply(--layout-flex-2);
      };
      .rightMarginmob {
        @apply(--layout-flex-0);
      };
      .view {
        @apply(--layout-flex-8);
      };
      .viewSection {
        object-fit: cover;
      };
      .view img {
        width: 100%;
        margin-bottom: 20px;
      };
      .view #viewText {
        font-size: 24px;
        margin-bottom: 10px;
      };
      .view polymer-quill-html-render {
        --calculated-polymer-quill-html-padding: 0;
      };
      polymer-quill {
        --polymer-quill-editor-min-width: 95%;
      };
      img {
        object-fit: cover;
      };
    </style>
    <!-- Desktop Opened -->
    <template is="dom-if" if="{{wide}}">
      <div class="box">
        <div class="leftMargin"></div>
        <div class="view">
          <h1>[[title]]</h1>
          <template is="dom-if" if="[[bigImage]]">
            <img src="[[bigImage]]" title="bigImage" style="max-height:400px" class="viewSection" />
          </template>    
          <template is="dom-if" if="[[!bigImage]]">
            <template is="dom-if" if="[[image]]">
              <img src="[[image]]" title="image" style="max-height:400px" class="viewSection" />
            </template>
          </template>
          <div id="viewText" class="viewSection">[[desc]]</div>
          <template is="dom-if" if="[[article]]">
            <quill-js class="viewSection" value="[[article]]" show style="max-height:95vh"></quill-js>
          </template>
        </div>
        <div class="rightMargin"></div>
      </div>
    </template>
    <!-- Mobile Opened -->
    <template is="dom-if" if="{{!wide}}">
      <div class="box">
        <div class="leftMarginmob"></div>
        <div class="view">
          <h1>[[title]]</h1>
          <img src="[[bigImage]]" class="viewSection" />
          <div id="viewText" class="viewSection">[[desc]]</div>
          <quill-js class="viewSection" value="[[article]]" show style="max-height:95vh"></quill-js>
        </div>
        <div class="rightMarginmob"></div>
      </div>
    </template>
  </template>
</dom-module>
<script>
  Polymer({
    is: "content-view",
    properties:{
      online: {
        type:Boolean,
        notify:true,
      },
      html: {
        value:""
      },
      pillar:Object,
      wide: {
        type:Boolean,
        value:false,
      },
      locked: {
        type:Boolean,
        value:false,
      },
      _loadValues: {
        computed: "loadAllFirebase(key)",
      },
      firebaseSaveAt: {
        value: {},
      },
      writable: Object,
      readable: Object,
    },
    getIt:function(it){
      return it
    },
    loadAllFirebase: function(key) {
      this.async(this.loadFirebase(key, 'bigImage'))
      this.async(this.loadFirebase(key, 'title'))
      this.async(this.loadFirebase(key, 'image'))
      this.async(this.loadFirebase(key, 'article'))
      this.async(this.loadFirebase(key, 'desc'))
    // this.async(this.loadFirebase(key, 'writable'))
    // this.loadFirebase(key,opened,'readable')
    },
    loadFirebase: function(key, name){
      if (firebase) { // && (!this.sub || !this.sub[key + name])
        var that = this
        var path = "/Cards/" + key + "/" + name
        if (!this.sub) {
          this.sub = {}
        }
        var ref = firebase.database().ref(path + "/").limitToLast(1)
        var update = function(snapshot) {
          var val = snapshot.val()
          if (val) {
            var valueWithTime = that.decode(val, that[name], 0)
            if (valueWithTime && JSON.stringify(that[name]) !== JSON.stringify(valueWithTime.value)) {
              that[name] = valueWithTime.value
              that.firebaseSaveAt[name] = valueWithTime.time
            } 
          } else if (val == null){
            ref.off()
            that.firebaseSaveAt[name] = 1 // not got a value from firebase
          }
        }
        ref.on('value', update)
      }
    },
   /**
    *
    * @return {value:array|string,time: number}|false
    *
    **/
    decode: function(val,localVal,theDate){
      if (typeof val == 'object' && !val.value) {
        if (Object.keys(val)[0].length == 42) {
          return this.decode(val[Object.keys(val)[0]],localVal,theDate)
        }
      }
      var Delta = Quill.import('delta')
      if (typeof val == 'string') {
        try {
          return JSON.parse(val);
        } catch(e) {
          return val
        }
      } 
      if(localVal) {
        try {
          localVal = JSON.parse(localVal);
        } catch(e) {
        }
      }
      if (typeof val == 'object' && (typeof val.value == 'string' || Array.isArray(val.value)) && +val.time) {
        if (val.value !== localVal || !localVal) {
          return {
            value: val.value,
            time:  +val.time,
          }
        } else {
          return {
            value: localVal,
            time:  +theDate,
          }
        }
      } else {
        return false
      }
    },
    open: function(){
      if (this.locked) {
        this.fire("open","content-card")
      } else {
        this.fire("open",this)
      }
    },
  })
</script>
