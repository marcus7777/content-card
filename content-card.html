<link rel="import" href="../paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../paper-tabbed-pages/paper-tabbed-pages.html">
<link rel="import" href="../polymer-quill/polymer-quill.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../polymer/polymer.html">
<!--
  `<content-card></content-card>` svg
  @demo demo.html
-->
<dom-module id="content-card">
  <template>
    <style is="custom-style">
      polymer-quill {
        --polymer-quill-editor-max-height: 400px;
        --polymer-quill-editor-min-height: 300px;
      }
      :host {
        display:block;
        color:#505050;
        font-family: Roboto, Arial, Helvetica, sans-serif;
        min-height: 225px;
      }
      h2 {
        font-weight: 300;
        font-size: 18px;
        margin: 0px;
        display: block;
        width: 180px;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        margin: 0px 10px;
      }
      .container {
        min-height: 225px;
        text-align: center;
      }
    </style>
    <template is="dom-if" if="[[!opened]]">
      <div on-tap="open" class="container">
        <template is="dom-if" if="[[image]]">
          <iron-image contain style="max-height:150px" src="[[image]]"></iron-image>
        </template>
        <template is="dom-if" if="[[!image]]">
          <div style="height:100px"></div>
        </template>
        <h2 style="text-align: center">[[title]]</h2>
        <div>[[desc]]</div>
      </div>
    </template>
    <template is="dom-if" if="[[opened]]">
      <polymer-quill hidden content="[[fbValue]]" html="{{a}}"></polymer-quill>
      <template is="dom-if" if="[[pillar.view]]">
        <paper-dialog-scrollable style="height: 100%;width: 100%;min-height: 300px;min-width: 500px">
          <div inner-h-t-m-l="{{a}}"></div>
        </paper-dialog-scrollable>
      </template>
      <template is="dom-if" if="[[pillar.edit]]">
        <polymer-quill style="min-height: 300px;min-width: 500px" content="{{value}}" toolbar-type="full"></polymer-quill>
      </template>
    </template>  
  </template>
</dom-module>
<script>
  Polymer({
    is: "content-card",
    properties:{
      edit:{
        type:Boolean,
        value:false,
      },
      pillar:{
        value:{view:true,color:"#f2d123",name: "View"}
      },
      decks:{
        computed:"getDecks(title,edit)",
        notify:true,
      },
      value:{
        type:Object,
        notify:true,
      },
      opened:{
        type:Boolean,
        value:false,
      },
      locked:{
        type:Boolean,
        value:false,
      },
      _updateFirebase:{
        computed:"updateFirebase(value,key)",
      },
      _loadValue:{
        computed:"loadFirebase(key)",
      },
    },
    getDecks: function(title,edit) {
      //TODO DRY
      if (edit) {
        return [{view: true,selected: true,color: "#f2d123",name: "View"},{name: "Edit",edit: true,color: "#1d1e30"}]
      } else {
        return [{view:true,color:"#f2d123",name: title}]
      }
    },
    loadFirebase: function(key){
      if (firebase) {
        var that = this
        var path = "Cards/" + key
        return firebase.database().ref(path+"/value").on('value', function(snapshot) {
          var val = snapshot.val()
          if (val && JSON.stringify(val) !== JSON.stringify(that.value)) {
            if (typeof val !== 'string') {
              that.fbValue = JSON.stringify(val)
              that.value   = JSON.stringify(val)
            } else {
              that.fbValue = val
              that.value   = val
            }
          } else {
            if (that.edit) {
              that.tab = "edit"
            }
          }
        })
      }
    },
    updateFirebase: function(value, key){
      if (firebase && value && JSON.stringify(value) !== JSON.stringify(this.fbValue)) {
        var path = "Cards/" + key
        var updates = {}
        updates[path+"/value"] = value
        return firebase.database().ref().update(updates)
      }
    },
    open: function(){
      this.fire("open",this)
    },
  })
</script>
