<link rel="import" href="../paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../paper-tabbed-pages/paper-tabbed-pages.html">
<link rel="import" href="../polymer-quill/polymer-quill.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../polymer/polymer.html">
<!--
  `<content-card></content-card>` svg
  @demo demo.html
-->
<dom-module id="content-card">
  <template>
    <style>
      h2 {
        font-weight: 300;
        font-size: 18px;
        margin: 0px;
        display: block;
        width: 180px;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        margin: 0px 10px;
      }
      .container {
        text-align: center;
      }
    </style>
    <div on-tap="open">
      <template is="dom-if" if="[[image]]">
        <iron-image contain src="[[image]]"></iron-image>
      </template>
      <h2 style="text-align: center">[[title]]</h2>
      <div class="container">[[desc]]</div>
    </div>
    <paper-dialog id="dialog">
      <template is="dom-if" if="[[edit]]">
        <paper-tabbed-pages style="padding:0" tabs='["preview","edit"]'>
          <preview-tab>
            <paper-dialog-scrollable>
              <div inner-h-t-m-l="{{a}}"></div>
            </paper-dialog-scrollable>
          </preview-tab>
          <edit-tab>
            <polymer-quill content="{{value}}" toolbar-type="full" html="{{a}}"></polymer-quill>
          </edit-tab>
          <stats-tab>
            no stats 
          </stats-tab>
        </paper-tabbed-pages>
      </template>
      <template is="dom-if" if="[[!edit]]">
        <polymer-quill hidden content="[[fbValue]]" html="{{a}}"></polymer-quill>
        <div inner-h-t-m-l="{{a}}"></div>
      </template>
    </paper-dialog>
  </template>
</dom-module>
<script>
  Polymer({
    is: "content-card",
    properties:{
      edit:{
        type:Boolean,
        value:false,
      },
      value: {
        type:Object,
        notify:true,
      },
      locked:{
        type:Boolean,
        value:false,
      },
      _updateFirebase:{
        computed:"updateFirebase(value,key)",
      },
      _loadValue: {
        computed:"loadFirebase(key)",
      },
    },
    loadFirebase: function(key){
      if (firebase) {
        var that = this
        var path = "Cards/" + key
        return firebase.database().ref(path+"/value").on('value', function(snapshot) {
          var val = snapshot.val()
          if (val && JSON.stringify(val) !== JSON.stringify(that.value)) {
            if (typeof val !== 'string') {
              that.fbValue = JSON.stringify(val)
              that.value   = JSON.stringify(val)
            } else {
              that.fbValue = val
              that.value   = val
            }
           
          }
        })
      }
    },
    updateFirebase: function(value, key){
      if (firebase && value && JSON.stringify(value) !== JSON.stringify(this.fbValue)) {
        var path = "Cards/" + key
        var updates = {}
        updates[path+"/value"] = value
        return firebase.database().ref().update(updates)
      }
    },
    open: function(){
      if (!this.locked) {
        this.$.dialog.open()
      } else {
        this.fire("open","content-card")
      }
    },
  })
</script>
