<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-localstorage/iron-localstorage.html">
<link rel="import" href="../browserify-delta/browserify-delta.html">
<link rel="import" href="../iron-media-query/iron-media-query.html">
<link rel="import" href="../card-meta-edit/card-meta-edit.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../quill-js/quill-js.html">
<link rel="import" href="../polymer/polymer.html">
<!--
  `<content-card></content-card>`
  @demo demo.html
-->
<dom-module id="content-card">
  <template>
    <style is="custom-style">
      :host {
        display:block;
        color:#505050;
        font-family: Roboto, Arial, Helvetica, sans-serif;
        font-weight: 300;
      };
      .container {
        min-height: 225px;
        text-align: center;
      };
      .box {
        @apply(--layout-horizontal);
      };
      .leftMargin {
        @apply(--layout-flex-2);
      };
      .leftMarginmob {
        @apply(--layout-flex-0);
      };
      .rightMargin {
        @apply(--layout-flex-2);
      };
      .rightMarginmob {
        @apply(--layout-flex-0);
      };
      .view {
        @apply(--layout-flex-8);
      };
      .viewSection {
        object-fit: cover;
      };
      .view img {
        width: 100%;
        margin-bottom: 20px;
      };
      .view #viewText {
        font-size: 24px;
        margin-bottom: 10px;
      };
      .view polymer-quill-html-render {
        --calculated-polymer-quill-html-padding: 0;
      };
      polymer-quill {
        --polymer-quill-editor-min-width: 95%;
      };
      img {
        object-fit: cover;
      };
    </style>

    <iron-media-query query="(min-width:700px)" query-matches="{{wide}}"></iron-media-query>
    
    <template is="dom-if" if="[[!opened]]">
      <div on-tap="open" class="container">
        <template is="dom-if" if="[[image]]">
          <!-- Desktop Closed -->
          <template is="dom-if" if="{{wide}}">
            <template is="dom-if" if="[[image]]">
              <img style="max-width:100%;max-height:120px" src="[[image]]" />
            </template>
            <h2 style="text-align:center;font-weight:300;font-size:20px;margin-top:20px">[[title]]</h2>
          </template>
          <!-- Mobile Closed -->
          <template is="dom-if" if="{{!wide}}">
            <template is="dom-if" if="[[image]]">
              <img style="max-width:100%;max-height:200px;" src="[[image]]" />
            </template>
            <h2 style="text-align:center;font-weight:300;font-size:40px;margin-top:40px">[[title]]</h2>
          </template>
        </template>
        <template is="dom-if" if="[[!image]]">
          <div style="height:50px"></div>
          <h2 style="text-align:center;font-weight:300;font-size:20px;">[[title]]</h2>
          <div>[[desc]]</div>
        </template>
      </div>
    </template>
    <template is="dom-if" if="[[opened]]">
      <div hidden="[[!pillar.edit]]" style="width:100%;float:right">
        <card-meta-edit title="{{title}}" image="{{image}}" big-image="{{bigImage}}" desc="{{desc}}"></card-meta-edit>
        <template is="dom-if" if="[[restamp]]" restamp>
          <quill-js id="editor" syntax use-content-reset content="[[article]]" html="{{html}}" content="[[article]]" toolbar-type="auto" on-change="save" on-update="apiSave"></quill-js>
        </template>
        <paper-toast text="Saved" opened="{{saved}}"></paper-toast>
        <paper-toast text="Error" opened="{{notSaved}}"></paper-toast>
        <paper-toast text="Updated" opened="{{apiSaved}}"></paper-toast>
        <paper-button raised on-tap="delete" style="color:red">delete</paper-button>
      </div>
      <template is="dom-if" if="[[pillar.view]]">
        <!-- Desktop Opened -->
        <template is="dom-if" if="{{wide}}">
          <div class="box">
            <div class="leftMargin"></div>
            <div class="view">
              <template is="dom-if" if="[[bigImage]]">
                <img src="[[bigImage]]" title="bigImage" style="max-height:400px" class="viewSection" />
              </template>
              
              <template is="dom-if" if="[[!bigImage]]">
                <template is="dom-if" if="[[image]]">
                  <img src="[[image]]" title="image" style="max-height:400px" class="viewSection" />
                </template>
              </template>
              
              <div id="viewText" class="viewSection">[[desc]]</div>
              <quill-js class="viewSection" content="[[html]]" style="max-height:95vh"></quill-js>
            </div>
            <div class="rightMargin"></div>
          </div>
        </template>
        <!-- Mobile Opened -->
        <template is="dom-if" if="{{!wide}}">
          <div class="box">
            <div class="leftMarginmob"></div>
            <div class="view">
              <img src="[[bigImage]]" class="viewSection" />
              <div id="viewText" class="viewSection">[[desc]]</div>
              <polymer-quill-html-render class="viewSection" content="[[html]]" style="max-height:95vh"></polymer-quill-html-render>
              [[error]]
            </div>
            <div class="rightMarginmob"></div>
          </div>
        </template>
      </template>
    </template>
 <!--   <iron-localstorage on-iron-localstorage-load-empty="initializeLocalData" value="{{localData}}" id="theLocalData" name="[[key]]"></iron-localstorage>
-->
  </template>
</dom-module>
<script>
  Polymer({
    is: "content-card",
    properties:{
      restamp:{
        type:Boolean,
        value:true,
      },
      edit: {
        computed:"isEditable(writable,user)"
      },
      uid: {
        computed:"getIt(user.uid)"
      },
      online: {
        type:Boolean,
      },
      html: {
        value:""
      },
      pillar:Object,
      pillars: {
        computed:"getPillars(title,edit)",
        notify:true,
      },
      value: {
        value:"{}",
        type:String,
      },
      opened: {
        type:Boolean,
        value:false,
      },
      wide: {
        type:Boolean,
        value:false,
      },
      saved: {
        type:Boolean,
        value:false,
      },
      apiSaved:{
        type:Boolean,
        value:false,
      },
      locked: {
        type:Boolean,
        value:false,
      },
      _loadValue: {
        computed: "loadFirebase(key,opened,'article',pillar)",
      },
      _loadValueBigImage: {
        computed: "loadFirebase(key,opened,'bigImage',pillar)",
      },
      _loadReadable: {
        // computed: "loadFirebase(key,opened,'readable',pillar)",
      },
      _loadWritable: {
        computed: "loadFirebase(key,opened,'writable',pillar)",
      },
      _loadLocalArticle: {
        computed: "loadLocalvalues(article,localData.article.value,'article')",
      },
      _loadLocalBigImage: {
        computed: "loadLocalvalues(bigImage,localData.bigImage.value,'bigImage')",
      },
      _loadLocalReadable: {
       // computed: "loadLocalvalues(readable,localData.readable.value,'readable')",
      },
      _loadLocalWritable: {
        computed: "loadLocalvalues(writable,localData.writable.value,'writable')",
      },     
      _loadLocalTitle: {
        computed: "loadLocalvalues(title,localData.title.value,'title')",
      },
      writable: Object,
      bigImage: {
        value: "",
      },
      image: {
        value: "",
      },
      title: {
        value: "",
      },
      desc: {
        value: "",
      },
      updateTimer: {
        value: {},
      },
      _updateFirebaseCardImage: {
        computed: "updateFirebase(deck,key,opened,'image',image,0,edit,uid,0)",
      },
      _updateFirebaseCardBigImage: {
        computed: "updateFirebase(deck,key,opened,'bigImage',bigImage,1,edit,uid,0)",
      },
      _updateFirebaseCardTitle: {
        computed: "updateFirebase(deck,key,opened,'title',title,0,edit,uid,0)",
      },
      _updateFirebaseCardDesc: {
        computed: "updateFirebase(deck,key,opened,'desc',desc,0,edit,uid,0)",
      },
      _useLocalData: {
        computed: "useLocalData(localData)",
      }
    },
    loadLocalvalues: function(dataVal,localDataVal,key) {
      if (JSON.stringify(dataVal) != JSON.stringify(localDataVal) ){
        this[key] == localDataVal
      }
    },
    useLocalData: function(localData){
      if (localData) {
        if (localData.title && localData.title.value != this.title) {
          this.title = localData.title.value
        }
      }
    },
    delete: function(){
      var path = "/Decks/" + this.deck + "/cards/" + this.key 
      var updates = {}
      updates[path] = null
      updates["/Cards/" + this.key] = null
      this.fire("deleted",firebase.database().ref().update(updates))
    },
    getIt:function(it){
      return it
    },
    isEditable: function(writable,user){
      if (user && user !== null) { 
        if (typeof writable === "string") {
          writable = JSON.purse(writable)
        }
        return writable[user.uid] || writable.all
      } else {
        return writable.all
      }
    },
    initializeLocalData: function(){
      if (!this.localData) {
        this.localData = {}
      }
    },
    updateFirebase: function(deck,key,opened,name,value,cardOnly,edit,uid,time){
      console.log(deck,key,opened,name,value.length,cardOnly,edit,uid,time)
      
      if (!time) {
        time = Date.now()
      }
      var saveLocal = function(){
        if (value) {
//          if (!that.localData) {
//            that.localData = {}
//          }
//          if (!that.localData[name]) {
//            that.localData[name] = {}
//          }
//          that.localData[name].value = that.decode(value, that.localData[name].value, that.localData[name].updated)
//          that.localData[name].updated = time
          // that.$$("#theLocalData").save()
        }
      }
      var reverse = function(toReverse) {
        return ("00"+toReverse).split("").map(function(n){
          return 9 - +n
        }).splice(-14).join("")
      }
      var that = this
      var updateInterval = 2000
      var updatePeriodically = function() {
        var oldValue
        var newValue
        if (that.localData && that.localData[name]) {
          if (that.localData[name].value) {
            oldValue = that.localData[name].value
          } else {
            oldValue = ""
          }
          newValue = that.decode(value, that.localData[name].value, that.localData[name].updated)
        } else {
          saveLocal()
          oldValue = ""
          newValue = value
        }
         // console.log("oldValue.length",oldValue.length,"newValue.length",newValue.length)
        if (opened && firebase && edit && deck && name && value && uid && uid != null ) { // && JSON.stringify(oldValue) !== JSON.stringify(newValue)) {
          var path = "/Decks/" + deck + "/cards/" + key
          var updates = {}
          if (!cardOnly) {
            updates[path + "/" + name + "/"] = value
          }
          updates["/Cards/" + key + "/" + name + "/" +  reverse(time) + uid] = {
            value: value,
            time: firebase.database.ServerValue.TIMESTAMP,
            user: uid,
          }
         // if (that.online) {// && diff.ops.length) {
            
         // }
          console.log(updates)
          return firebase.database().ref().update(updates).then(function() {
            console.log("saved", updates)
            that.saved = true
          }).catch(function(r) {
            console.log("not saved",r,updates)
          })
        }
      }
      
      clearTimeout(this.updateTimer[name])
      this.updateTimer[name] = setTimeout(updatePeriodically, updateInterval)
    },
    getPillars: function(title,edit) {
      var pillars = [{view: true,selected: true,color: "#f2d123",name: title}]
      if (edit) {
        return pillars.concat([{name: "Edit",edit: true,color: "#1d1e30"}])
      } else {
        return pillars
      }
    },
    loadFirebase: function(key, opened, name, localData){
      if (firebase && opened && (!this.sub || !this.sub[key + name])) {
        var that = this
        var path = "/Cards/" + key + "/" + name
        if (!this.sub) {
          this.sub = {}
        }
        var update = function(snapshot) {
          var val = snapshot.val()
          if (val) {
            if (!that.localData) {
              that.localData = {}
            }
            if (!that.localData[name]) {
              that.localData[name] = {}
            }
            
            that[name] = that.decode(val,that.localData[name].value,that.localData[name].updated)
            
            that.localData[name].value = that[name]
            that.localData[name].updated = Date.now()
          }
        }
        this.sub[key + name] = true
        if (that.localData && that.localData.hasOwnProperty(name) && that.localData[name].updated) {
          // Get up to date with the server
          firebase.database().ref(path + "/").orderByChild("time").startAt(that.localData[name].updated).once('value', update)
        } else {
          // No local data get complete document
          firebase.database().ref(path + "/").once('value', update)
        }
        return firebase.database().ref(path + "/").on('child_added', update)
      }
    },
    decode: function(val,localVal,theDate){
      if (typeof val == 'string') {
        return val
      }
      if (typeof val == 'object' && typeof val.value == 'string') {
        if (val.time > theDate || val.value == localVal || !localVal) {
          return val.value
        } else {
          return localVal
        }
      }
      var byChild = "time"
      var sortByChild = function(a,b){
        if (a.hasOwnProperty(byChild) && b.hasOwnProperty(byChild)) {
          var A = +a[byChild]
          var B = +b[byChild]
        
          if (A < B) { return -1 }
          if (A > B) { return 1 }
        }
        return 0
      }
      var ops
      if (typeof val == 'object' && val.value) {
        return this.decode(val.value,localVal,theDate)
      }
      if (localVal && Array.isArray(localVal)) {
        ops = new Delta(localVal)
      } else if (localVal && localVal.ops) {
        ops = new Delta(localVal.ops)
      } else if (val && val.ops){
        // think out
        ops = new Delta()
      } else {
        ops = new Delta()
      }
      if (val !== false) {
        if (typeof val == 'object') {
          //1 val keys
          //2 val.hasOwnProperty('time')
          //3 val.ops
          var editOps
          if (val[Object.keys(val)[0]].hasOwnProperty(byChild)) { 
            var unsorted = []
            for (var entry in val) {
              unsorted.push(val[entry])
            }
            var sorted = unsorted.sort(sortByChild)
            editOps = sorted.map(function(a){
              return a.value.ops
            })
            ops = ops.compose({ops: editOps})
          } else {
            for (var edit in val) {
              if (typeof val[edit].value == 'object') {
                editOps = []
                for (var op in val[edit].value.ops) {
                  editOps.push(val[edit].value.ops[op])
                }
                ops = ops.compose({ops: editOps})
              } else if (typeof val[edit].value == 'string') {
                return val[edit].value
              }
            }
          }
          if (ops.ops.length) {
            return ops.ops
          }
        } else if (localVal) {
          return localVal
        } else if (val) {
          return val
        }
      } else {
        return null
      }
    },
    save: function(e,d){
      if (this.opened && this.pillar.edit) {
        if (!this.localData) {
          this.localData = {}
        }
        if (!this.localData.article) {
          this.localData.article = {}
        }
        var diff = e.detail.delta
        if (diff.ops.length) {
          this.localData.article.value = d.entireDelta.ops
          var time = Date.now()
          this.localData.article.updated = time
          this.updateFirebase(this.deck,this.key,this.opened,'article',d.delta, true, this.edit, this.uid, time)
        }
      }
    },
    apiSave: function(e,d){
      if (this.opened && this.article && this.pillar.edit) {
        this.apiSaved = true
      }
    },
    open: function(){
      if (this.locked) {
        this.fire("open","content-card")
      } else {
        this.fire("open",this)
      }
    },
    ready: function() {
      this.user = firebase.auth().currentUser
      if (this.online !== true || this.online !== false) {
        var that = this
        firebase.database().ref(".info/connected").on("value", function(snap) {
          if (snap.val() === true) {
            that.online = true
          } else {
            that.online = false
          }
        })
      }
    }
  })
</script>
