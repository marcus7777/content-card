<link rel="import" href="../card-meta-edit/card-meta-edit.html">
<link rel="import" href="../polymer-quill/polymer-quill-html-render.html">
<link rel="import" href="../polymer-quill/polymer-quill.html">
<link rel="import" href="../iron-localstorage/iron-localstorage.html">
<link rel="import" href="../browserify-delta/browserify-delta.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../polymer/polymer.html">
<!--
  `<content-card></content-card>`
  @demo demo.html
-->
<dom-module id="content-card">
  <template>
    <style is="custom-style">
      :host {
        display:block;
        color:#505050;
        font-family: Roboto, Arial, Helvetica, sans-serif;
      };
      .container {
        min-height: 225px;
        text-align: center;
      };
      polymer-quill {
        --polymer-quill-editor-min-width: 95%;
      };
    </style>
    <template is="dom-if" if="[[!opened]]">
      <div on-tap="open" class="container">
        <template is="dom-if" if="[[image]]">
          <iron-image contain style="max-height:150px" src="[[image]]"></iron-image>
          <h2 style="text-align:center">[[title]]</h2>
        </template>
        <template is="dom-if" if="[[!image]]">
          <div style="height:50px"></div>
          <h2 style="text-align:center">[[title]]</h2>
          <div>[[desc]]</div>
        </template>
      </div>
    </template>
    <template is="dom-if" if="[[opened]]">
        <div hidden="[[!pillar.edit]]" style="width:100%;float:right">
          <card-meta-edit title="{{title}}" image="{{image}}" desc="{{desc}}"></card-meta-edit>
          <template is="dom-if" if="[[restamp]]" restamp>
            <polymer-quill id="editor" syntax use-content-reset content="[[article]]" html="{{html}}" content="[[article]]" toolbar-type="full" on-change="save" on-update="apiSave"></polymer-quill>
            <paper-toast text="Saved" opened="{{saved}}"></paper-toast>
            <paper-toast text="Updated" opened="{{apiSaved}}"></paper-toast>
          </template>
        </div>
      <template is="dom-if" if="[[pillar.view]]">
        <iron-image contain style="max-height:200px;float:left" src="[[image]]"></iron-image>
        <div>
          <div>[[desc]]</div>
        </div>
        <polymer-quill-html-render content="[[html]]" style="overflow:scroll;max-height:95vh"></polymer-quill-html-render>
      </template>
    </template>
    <iron-localstorage value="{{localData}}" name="[[key]]"></iron-localstorage>
  </template>
</dom-module>
<script>
  Polymer({
    is: "content-card",
    properties:{
      restamp:{
        type:Boolean,
        value:true,
      },
      edit: {
        computed:"isEditable(writable,user)"
      },
      uid: {
        computed:"getIt(user.uid)"
      },
      online: {
        type:Boolean,
      },
      html: {
        value:""
      },
      pillar:Object,
      pillars: {
        computed:"getPillars(title,edit)",
        notify:true,
      },
      value: {
        value:"{}",
        type:String,
      },
      opened: {
        type:Boolean,
        value:false,
      },
      saved: {
        type:Boolean,
        value:false,
      },
      apiSaved:{
        type:Boolean,
        value:false,
      },
      locked: {
        type:Boolean,
        value:false,
      },
      _loadValue: {
        computed: "loadFirebase(key,opened,'article',pillar)",
      },
      _loadReadable: {
        // computed: "loadFirebase(key,opened,'readable',pillar)",
      },
      _loadWritable: {
        computed: "loadFirebase(key,opened,'writable',pillar)",
      },
      writable: Object,
      image: {
        value: "",
      },
      title: {
        value: "",
      },
      desc: {
        value: "",
      },
      _updateFirebaseCardImage: {
        computed: "updateFirebase(deck,key,opened,'Image',image,0,edit,uid)"
      },
      _updateFirebaseCardTitle: {
        computed: "updateFirebase(deck,key,opened,'title',title,0,edit,uid)"
      },
      _updateFirebaseCardDesc: {
        computed: "updateFirebase(deck,key,opened,'desc',desc,0,edit,uid)"
      },
    },
    getIt:function(it){
      return it
    },
    isEditable: function(writable,user){
      if (user && user !== null) { 
        if (typeof writable === "string") {
          writable = JSON.purse(writable)
        }
        return writable[user.uid] || writable.all
      } else {
        return writable.all
      }
    },
    updateFirebase: function(deck,key,opened,name,value,cardOnly,edit,uid,time){
      if (!this.localData) {
        this.localData = {}
      }
      if (!time) {
        time = Date.now()
      }
      
      if (opened && firebase && edit && deck && value && uid && uid != null && (this.localData[name] && this.localData[name].value !== value || cardOnly) ) {
       
        var path = "/Decks/" + deck + "/cards/" + key 

        var updates = {}
        if (!cardOnly) {
          updates[path + "/" + name + "/"] = value
        }
        
        updates["Cards/" + key + "/" + name + "/" + time + "q" + uid] = {
          value: value,
          time: firebase.database.ServerValue.TIMESTAMP,
          user: uid,
        }
        if (this.localData && this.localData.article && this.localData.article.value) {
          var opsLocal = new Delta(this.localData.article.value)
          var opsLocalEditor = new Delta(this.$$('#editor').quill.getContents())
          var diff = opsLocal.diff(opsLocalEditor)

          if (this.online && diff.ops.length) {
            this.saved = true
          }
        }
        return firebase.database().ref().update(updates)
      } else {
        if (!this.localData[name]) {
          this.localData[name] = {}
        }
        this.localData[name].value = this.decode(value,this.localData[name])
        this.localData[name].update = time
      }
    },
    getPillars: function(title,edit) {
      var pillars = [{view: true,selected: true,color: "#f2d123",name: title}]
      if (edit) {
        return pillars.concat([{name: "Edit",edit: true,color: "#1d1e30"}])
      } else {
        return pillars
      }
    },
    loadFirebase: function(key, opened, name){
      if (!this.localData) {
        this.localData = {}
      }
      if (firebase && opened && (!this.sub || !this.sub[key + name])) {
        var that = this
        var path = "Cards/" + key + "/" + name
        if (!this.sub) {
          this.sub = {}
        }
        var update = function(snapshot) {
          var val = snapshot.val()
          if (val) {
            if (!that.localData) {
              that.localData = {}
            }
            if (!that.localData[name]) {
              that.localData[name] = {}
            }
            that[name] = that.decode(val,that.localData[name].value,that.localData[name].updated)
            that.localData[name].value = that[name]
            that.localData[name].updated = Date.now()
          }
        }
        this.sub[key + name] = true
        return firebase.database().ref(path+"/").on('value', update)
      }
    },
    decode: function(val){
      var ops = new Delta()
      for (var edit in val) {
        if (typeof val[edit].value == 'object') {
          var editOps = []
          for (var op in val[edit].value.ops) {
            editOps.push(val[edit].value.ops[op])
          }
          ops = ops.compose({ops: editOps})
        } else {
          if (typeof val[edit].value == 'string') {
            return val[edit].value
          } else {
            return val
          }
        }
      }
      return ops.ops
    },
    save: function(e,d){
      if (this.opened && this.pillar.edit) {
        if (!this.localData) {
          this.localData = {}
        }
        if (!this.localData.article) {
          this.localData.article = {}
        }
        var opsLocal = new Delta(this.localData.article.value)
        var opsLocalEditor = new Delta(d.entireDelta)
        var diff = opsLocal.diff(opsLocalEditor)
        
        if (diff.ops.length) {
          this.localData.article.value = d.entireDelta.ops
          var time = Date.now()
          this.localData.article.updated = time
          this.updateFirebase(this.deck,this.key,this.opened,'article',d.delta, true, this.edit, this.uid, time)
        }
      }
    },
    apiSave: function(e,d){
      if (this.opened && this.article && this.pillar.edit) {
        this.apiSaved = true
      }
    },
    open: function(){
      if (this.locked) {
        this.fire("open","content-card")
      } else {
        this.fire("open",this)
      }
    },
    ready: function() {
      this.user = firebase.auth().currentUser
      if (this.online !== true || this.online !== false) {
        var that = this
        firebase.database().ref(".info/connected").on("value", function(snap) {
          if (snap.val() === true) {
            that.online = true
          } else {
            that.online = false
          }
        })
      }
    }
  })
</script>
